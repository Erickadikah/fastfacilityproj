<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facility Management System - Guest</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* Custom CSS */
    body {
      font-family: Arial, sans-serif;
      {% comment %} background-color: #f8f9fa; {% endcomment %}
      background-image: url('../static/images/hm.jpg');
    background-size: cover; 
    background-repeat: no-repeat;
    background-attachment: fixed;
    overflow-x: hidden;
    }
    .navbar-brand {
      font-size: 24px;
      color: #007bff;
    }
    .sidebar {
      position: fixed;
      top: 56px;
      bottom: 0;
      left: 0;
      z-index: 100;
      width: 110px; /* Increased width for better readability */
      padding: 20px 0;
      background-color: #343a40;
      color: #fff;
      transition: width 0.3s;
      overflow-y: auto;
    }
    .sidebar.collapsed {
      width: 80px;
    }
    .sidebar-nav-link {
      color: #dee2e6;
      font-size: 18px;
      margin-bottom: 10px;
      transition: color 0.3s;
    }
    .sidebar-nav-link i {
      margin-right: 10px;
    }
    .sidebar-nav-link:hover {
      color: #fff;
      text-decoration: none;
    }
    .main-content {
      margin-left: 240px; /* Adjusted margin for better alignment */
      padding: 20px;
    }
    .card {
      margin-bottom: 20px;
      border: none;
      {% comment %} border-radius: 10px; {% endcomment %}
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .card-header {
      background-color: #007bff;
      color: #fff;
      border-radius: 10px 10px 0 0;
    }
    .card-title {
      font-size: 24px;
      margin-bottom: 0;
    }
    .card-body {
      padding: 10px;
    }
    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    /* Profile section */
#userProfile {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    width: 400px;
    z-index: 999;
    background-color: #ffffff;
    padding: 30px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    display: none;
}

#userProfile form {
    display: flex;
    flex-direction: column;
}

#userProfile .form-group {
    margin-bottom: 15px;
}

#userProfile label {
    font-weight: bold;
    color: #333333;
}

#userProfile input[type="text"],
#userProfile input[type="email"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #dddddd;
    border-radius: 5px;
}

#userProfile .btn {
    margin-top: 10px;
    padding: 10px 20px;
    border-radius: 5px;
}

#userProfile .btn-primary {
    background-color: #007bff;
    color: #ffffff;
}

#userProfile .btn-secondary {
    background-color: #6c757d;
    color: #ffffff;
}

#userProfile .btn-danger {
    background-color: #dc3545;
    color: #ffffff;
}

#userProfile .btn-success {
    background-color: #28a745;
    color: #ffffff;
}


#userProfile form {
  margin-bottom: 20px;
}

#userProfile label {
  font-weight: bold;
}

#userProfile input[type="text"],
#userProfile input[type="email"] {
  width: 100%;
  padding: 10px;
  margin-bottom: 20px;
  border: 1px solid #ced4da;
  border-radius: 5px;
}

#userProfile .btn {
  width: 45%;
  padding: 10px;
  margin-right: 10px;
}

#userProfile .btn:last-child {
  margin-right: 0;
}

#userProfile .text-center {
  text-align: center;
}

#userProfile .mt-3 {
  margin-top: 20px;
}
    #uploadDocumentsSection {
      position: fixed;
      top: 80px;
      right: 100px;
      z-index: 1000;
      width: 400px;
      padding: 20px;
      display: none;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    #notificationSection {
      left: 100px; /* Adjusted position for better alignment */
      position: fixed;
      top: 80px;
      width: 450px;
      z-index: 99;
      padding: 25px;
      display: none;
      overflow-y: auto;
      height: auto;
    }
    #uploadDocumentsSection {
      top: 150px;
      right: 2px;
    }
     #DocumentForm {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    display: none;
    padding: 20px;
    background-color: #343A40;
    width: 700px;
    height: 70vh;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    overflow-x: hidden;
    overflow-y: auto;
}
#DocumentForm.show {
    display: block !important;
}
 #documentList {
  list-style-type: none;
  padding: 0;
}

#documentList li {
  background-color: #f8f9fa;
  padding: 10px; 
  margin-bottom: 5px;
}

#documentList li:hover {
  background-color: #e9ecef;
}

#documentList li a {
  color: #007bff;
  text-decoration: none;
}

#documentList li a:hover {
  text-decoration: underline;
}

  </style>
</head>
<body>
  <!-- Navigation bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">Clients Dashboard</a>
    <button class="navbar-toggler" type="button" id="sidebarCollapseBtn">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'client_logout' %}">Logout</a>
        </li>
        <!-- Show logged-in user's name here -->
        {% if authenticated %}
        <li class="nav-item">
          <a class="nav-link text-success" href="#"> {{ client.username }} </a>
        </li>
        {% endif %}
      </ul>
    </div>
  </nav>
  <!-- Sidebar -->
  <div class="sidebar bg-dark text-light">
    <ul class="nav flex-column">
      <li class="nav-item">
        <a class="nav-link active" href="#" id="profileLink">
          <i class="fas fa-user fa-lg"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" id="notificationLink"
          ><i class="fas fa-bell fa-lg"></i
        ></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'client_logout' %}">
          <i class="fas fa-sign-out-alt fa-lg"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" id="toggleuserDocumentForm">
          <i class="fas fa-file-alt fa-lg"></i>
        </a>
      </li>
    </ul>
  </div>
  
   <!-- document Form-->
<div id="userDocumentForm">
    <div id="DocumentForm">
        <h3 class='text-center text-white'>Compliance Documents</h3>
        <ul class='mt-10' id="documentList">
        </ul>
    </div>
</div>

  <!-- Page content -->
  <div class="main-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <h1 class="h2">Dashboard</h1>
        </div>
      </div>
      <div class="row">
        <div class="row g-3">
          <div class="col-md-6">
              <div class="card border-primary mt-3">
                  <div class="card-header bg-primary text-white">
                      <h5 class="card-title mb-0">Rent Status</h5>
                  </div>
                  <div class="card-body">
                      <div class="row">
                          <div class="col-sm-6">
                              <h6 class="card-subtitle mb-2 text-muted">Next Payment Due</h6>
                              <p class="card-text">{{client.rentEndDate}}</p>
                          </div>
                          <div class="col-sm-6">
                              <h6 class="card-subtitle mb-2 text-muted">Payment Status</h6>
                              <p class="card-text text-success">Paid</p>
                          </div>
                      </div>
                      <div class="text-center">
                        <button type="button" class="btn" id="toggleDetailsBtn">View Details</button>
                      </div>
                      <!-- Additional details section -->
                      <div id="detailsSection" style="display: none;">
                        <h6 class="mt-3">More Information</h6>
                        <ul class="list-group mb-3">
                          <li class="list-group-item mb-3">Paid: {{ client.rentPayDate }}</li>
                          <li class="list-group-item mb-3">Ends: {{ client.rentEndDate }}</li>
                        </ul>
                      </div>                      
                  </div>
              </div>

          </div>
          <div class="col-md-6 g-5">
              <div class="card border-secondary mt-3">
                  <div class="card-header bg-success text-white">
                      <h5 class="card-title mb-0">Shared House Items</h5>
                  </div>
                  <div class="card-body">
                      <p class="card-text">These are the items shared in the house.</p>
                      <!-- Add an ID to the <ul> element for easy targeting -->
                      <ul class="list-group" id="sharedItemsList">
                          <li class="list-group mb-3">
                              <a href="#" class="list-group-item list-group-item-action">Kitchen Microwave</a>
                          </li>
                          <li class="list-group mb-3">
                              <a href="#" class="list-group-item list-group-item-action">Living Room TV</a>
                          </li>
                          <li class="list-group mb-3">
                              <a href="#" class="list-group-item list-group-item-action">Bathroom Heater</a>
                          </li>
                          <li class="list-group mb-3">
                              <a href="#" class="list-group-item list-group-item-action">Bedroom AC</a>
                          </li>
                          <li class="list-group mb-3">
                              <a href="#" class="list-group-item list-group-item-action">Kitchen Fridge</a>
                          </li>
                      </ul>
                  </div>
              </div>

          </div>
          <div class="col-md-6">
              <div class="card border-primary mt-5">
                  <div class="card-header bg-danger text-white">
                      <h5 class="card-title mb-0">None Shared House Items</h5>
                  </div>
                  <div class="card-body">
                      <p class="card-text">Non Shared Items</p>
                      <ul class="list-group">
                          <li class="list-group">
                              <a href="#" class="list-group-item list-group-item-action mb-3">Kitchen Cofee machine</a>
                          </li>
                          <li class="list-group">
                              <a href="#" class="list-group-item list-group-item-action mb-3">Living Room Computer</a>
                          </li>
                          <li class="list-group">
                              <a href="#" class="list-group-item list-group-item-action mb-3">Massage Chair</a>
                          </li>
                          <li class="list-group">
                              <a href="#" class="list-group-item list-group-item-action mb-3">Wine Cellar</a>
                          </li>
                      </ul>
                  </div>
              </div>
          </div>
          <div class="col-md-6">
            <div class="card border-primary mt-5">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Upload Signed Documents</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">If you haven't uploaded your signed documents yet, upload them now:</p>
                    <form id="uploadForm" method="post" enctype="multipart/form-data" action="{% url 'upload_document' client.id %}">
    {% csrf_token %}
    <div class="form-group">
        <label for="document">Select Document:</label>
        <input type="file" class="form-control-file" id="document" name="file">
    </div>
    <div class="form-group">
        <label for="description">File Description:</label>
        <input type="text" class="form-control" id="description" name="description">
    </div>
    <button type="submit" class="btn btn-primary">Upload</button>
</form>
                </div>
                <script>
    $(document).ready(function() {
        $('#uploadForm').submit(function(e) {
            e.preventDefault(); // Prevent the form from submitting normally
            
            var formData = new FormData(this); // Create FormData object from the form
            
            // Submit the form data via AJAX
            $.ajax({
                url: $(this).attr('action'), // Get the form action URL
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    // Parse the JSON response
                    var jsonResponse = JSON.parse(response);
                    
                    // Check if the upload was successful
                    if (jsonResponse.success) {
                        // Show success message
                        toastr.success(jsonResponse.message);
                        
                        // Optionally, you can reload the page after a delay
                        setTimeout(function() {
                            location.reload();
                        }, 3000);
                    } else {
                        // Show error message if upload failed
                        toastr.error(jsonResponse.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    // Handle error if needed
                }
            });
        });
    });
</script>
            </div>
        </div>        
      </div>
  </div>
</div> 
  <!-- Notification section -->
  <div id="notificationSection" style="display: none;">
    <!-- Notification content here -->
    <div class="card border-0">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">Notifications</h5>
      </div>
      <div class="card-body p-4">
        <div class="list-group list-group-flush" id="messageList">
          <!-- Messages will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>
 <!-- Profile section -->
 <div id="overlay" style="display: none; 400px; height: 300px; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
<div id="userProfile" style="display: none;">
  <!-- Profile toggle form -->
  <div>
    <form>
      <div class="form-group">
        <label for="username">Username</label>
        <input
          type="text"
          class="form-control"
          id="username"
          value="{{ client.username }}"
          readonly
        />
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input
          type="email"
          class="form-control"
          id="email"
          value="{{ client.email }}"
          readonly
        />
      </div>
      <div class="form-group">
        <label for="phone">Phone</label>
        <input
          type="text"
          class="form-control"
          id="phone"
          value="{{ client.phoneNumber }}"
          readonly
        />
      </div>
      <div class="form-group">
        <label for="rentPayDate">Rent Paid Date</label>
        <input
          type="text"
          class="form-control"
          id="rentPayDate"
          value="{{ client.rentPayDate }}"
          readonly
        />
      </div>
      <div class="form-group">
        <label for="rentAmount">Rent End Date</label>
        <input
          type="text"
          class="form-control"
          id="rentAmount"
          value="{{ client.rentEndDate }}"
          readonly
        />
      </div>
      <small class="form-text text-muted text-center mt-3">
        You can delete your profile in the settings page.
      </small>
    </form>
  </div>
</div>
  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script>
    $(document).ready(function () {
      $("#sidebarCollapseBtn").on("click", function () {
        $(".sidebar").toggleClass("collapsed");
        $(".main-content").toggleClass("collapsed");
      });
    
      $("#toggleDetailsBtn").click(function () {
        $("#detailsSection").toggle();
      });
    
      //notification section is hidden by default
    $("#notificationSection").hide();

    // Show profile section and hide other sections
    $("#profileLink").click(function() {
        $("#userProfile").toggle();
        $("#overlay").toggle(); // Toggle overlay
        $("#notificationSection").hide(); // Ensure notification section is hidden
        $("#uploadDocumentsSection").hide();
    });
    
     // Close profile section when overlay is clicked
    $("#overlay").click(function() {
        $("#userProfile").hide();
        $(this).hide();
    });
      
      $("#toggleuserDocumentForm").click(function () {
        $("#DocumentForm").toggleClass("show");
        $("#overlay").toggle(); // Toggle overlay
    });
      
      // Close the form and hide the overlay when the overlay is clicked
    $("#overlay").on("click", function() {
      $("#DocumentForm").removeClass("show");
      $(this).hide();
    });
    
      // Show notification section
       $("#notificationLink").click(function () {
        $("#notificationSection").toggle();
        $("#userProfile").hide();
        $("#uploadDocumentsSection").hide();
    });
    
      // Show upload documents section
      $("#uploadDocumentsLink").click(function () {
        $("#uploadDocumentsSection").toggle();
        $("#userProfile").hide();
        $("#notificationSection").hide();
      });
    
      // Edit profile
      $("#editProfileBtn").click(function () {
        // Code to enable editing fields
        $("#editProfileBtn").hide();
        $("#deleteProfileBtn").hide();
        $("#saveProfileBtn").show();
        $("#cancelProfileBtn").show();
      });
    
      // Cancel editing profile
      $("#cancelProfileBtn").click(function () {
        // Code to revert changes
        $("#editProfileBtn").show();
        $("#deleteProfileBtn").show();
        $("#saveProfileBtn").hide();
        $("#cancelProfileBtn").hide();
      });
    
      // Delete profile
      $("#deleteProfileBtn").click(function () {
        // Code to prompt confirmation
        $("#deleteProfileBtn").hide();
        $("#editProfileBtn").hide();
        $("#confirmDeleteProfileBtn").show();
        $("#cancelDeleteProfileBtn").show();
      });
    
      // Cancel profile deletion
      $("#cancelDeleteProfileBtn").click(function () {
        // Code to cancel deletion
        $("#deleteProfileBtn").show();
        $("#editProfileBtn").show();
        $("#confirmDeleteProfileBtn").hide();
        $("#cancelDeleteProfileBtn").hide();
      });
    });
    function fetchMessages() {
      $.ajax({
        url: '/get_messages/{{ client.id }}/',
        type: 'GET',
        success: function(response) {
          $('#messageList').empty(); // Clear existing messages
          
          if (response.messages && Array.isArray(response.messages)) {
            // If response contains messages array, iterate over messages
            response.messages.forEach(function(message) {
              displayMessage(message);
            });
            $('#notificationSection').show();
          } else {
            console.error('Invalid or missing messages array in response:', response);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error fetching messages:', error);
        }
      });
    }
    
    function displayMessage(message) {
    var messageHtml = `
        <a href="#" class="list-group-item list-group-item-action">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">New Message from ${message.sender}</h6>
                    <p class="mb-1">${message.content}</p>
                    <small class="text-muted">${message.created_at}</small>
                </div>
                <span class="badge badge-primary">New</span>
            </div>
    `;
    if (message.file) {
        messageHtml += `<a href="${message.file}" style='margin-bottom: 5px;' target="_blank">view</a>`;
    }

    messageHtml += `
            <div>
                <button class="btn btn-sm btn-danger delete-message-btn" data-message-id="${message.id}">Delete</button>
            </div>
        </a>
    `;

    $('#messageList').append(messageHtml);
}
    // Fetch messages on page load
    fetchMessages();
    
  
  // Function to delete message
// Function to delete message
function deleteMessage(messageId) {
  $.ajax({
    url: '/delete_message/' + messageId + '/', // Use the message ID in the URL
    type: 'POST',
    success: function(response) {
      console.log('Response:', response);
      // Check if the deletion was successful
      if (response.message === 'Message deleted successfully') {
        // Remove the message from UI
        toastr.success('Message deleted successfully');
        $('#messageList a[data-message-id="' + messageId + '"]').remove();
        setTimeout(function() {
          window.location.reload();
        }, 5000); // 5000 milliseconds = 5 seconds
      } else {
        console.error('Error deleting message:', response.error);
      }
    },
    error: function(xhr, status, error) {
      console.error('Error deleting message:', error);
    }
  });
}
// Event listener for delete message buttons
$(document).on('click', '.delete-message-btn', function() {
  // Retrieve the message ID from the data attribute
  var messageId = $(this).data('message-id');
  // Call the deleteMessage function with the message ID
  deleteMessage(messageId);
});
toastr.options = {
  closeButton: true,
  progressBar: true,
  preventDuplicates: true,
  newestOnTop: false,
  rtl: $('body').attr('dir') === 'rtl'
};

//docs 
// Function to fetch client using client ID
var clientId = {{ client_id }};
console.log(clientId)
function fetchClient(clientId) {
    return $.ajax({
        url: '/get_client/' + clientId, // Endpoint to fetch client by ID
        type: 'GET',
    });
}

// Function to fetch creator ID using client data
function fetchCreatorId(clientData) {
    // Assuming clientData contains the necessary information to fetch creator ID
    var creatorId = clientData.creator_id; // Adjust this based on your data structure
    return creatorId;
    console.log(creatorId)
}

// Function to display documents
function displayDocuments(response) {
    // Clear existing documents
    $('#documentList').empty();

    // Check if response is successful and contains files data
    if (response && response.success && response.files) {
        // Iterate over each file object in the response
        response.files.forEach(function(file) {
            // Create a list item for the file
            var listItem = $('<li></li>');

            // Add file details to the list item
            listItem.append('<p> Description: ' + file.description + '</p>');
            listItem.append('<p> Filename: ' + file.filename + '</p>');
            listItem.append('<a href="' + file.file_s3_url + '">Download</a>');
            
            //delete button
            var deleteButton = $('<button class="btn btn-sm btn-danger">Delete</button>');
        // Add an event listener to the delete button
       deleteButton.click(function() {
    // Call the delete_file_from_s3 function
    $.ajax({
        url: '/delete_file/' + file.id + '/',
        type: 'POST',
        data: { file_s3_url: file.file_s3_url },
        success: function(response) {
            if (response.success) {
                // Remove the list item if deletion is successful
                listItem.remove();
            } else {
                console.error('Error deleting file:', response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error deleting file:', error);
        }
    });
});
        // Append the delete button to the list item
        listItem.append(deleteButton);

        // Append the list item to the document list
        $('#documentList').append(listItem);
    });
}
}

// Fetch client using client ID
var clientId = {{ client_id }}; // Replace with the actual client ID
fetchClient(clientId)
    .then(function(clientData) {
        // Once client is fetched, fetch creator ID using client data
        var creatorId = fetchCreatorId(clientData);
        console.log(creatorId)
        
        // Now, fetch documents using creator ID
        $.ajax({
            url: '/download/' + creatorId + '/',
            type: 'GET',
            success: function(response) {
              console.log(response)
                // Display documents using the response
                displayDocuments(response);
            },
            error: function(xhr, status, error) {
                console.error('Error fetching documents:', error);
            }
        });
    })
    .catch(function(error) {
        console.error('Error fetching client:', error);
    });
  </script>
</body>
</html>
